@model ViotekErp.Models.GiderListViewModel
@using System.Linq

@{
    Layout = "_ErpLayout";
    ViewData["Title"] = "Giderler";

    var isAsc = (Model.Sort ?? "tarih_desc") == "tarih_asc";
    var nextSort = isAsc ? "tarih_desc" : "tarih_asc";

    string RangeText()
    {
        if (Model.Period == "all") return "Tüm Zamanlar";
        if (Model.StartDate.HasValue && Model.EndDate.HasValue)
            return $"{Model.StartDate:dd.MM.yyyy} — {Model.EndDate:dd.MM.yyyy}";
        return "-";
    }
}

@functions{
    string D(DateTime? v) => v.HasValue ? v.Value.ToString("dd.MM.yyyy") : "NULL";
    string S(string? v) => string.IsNullOrWhiteSpace(v) ? "NULL" : v!;
    string N2(double? v) => v.HasValue ? v.Value.ToString("N2") : "NULL";

    string Kur(double? tl, double? fx)
    {
        var a = tl ?? 0;
        var b = fx ?? 0;
        if (b == 0) return "—";
        var k = a / b;
        return k.ToString("N4");
    }
}

<style>
    /* Tailwind breakpointlerinden bağımsız kesin çözüm */
    .gdr-cards { display: none; }  /* default: web */
    .gdr-table { display: block; } /* default: web */

    @@media (max-width: 640px) {
        .gdr-cards { display: block; }
        .gdr-table { display: none; }
    }
</style>

<div class="min-h-[calc(100vh-64px)] bg-slate-50 px-6 py-6">

    <div class="flex items-start justify-between gap-4 mb-6">
        <div>
            <h1 class="text-3xl font-bold text-slate-900">Giderler</h1>
            <p class="text-sm text-slate-500 mt-1">Gider_Hareket tablosundan gelen kayıtlar.</p>
        </div>

        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 px-5 py-4 text-right">
            <div class="text-xs font-semibold tracking-[0.15em] text-slate-500 uppercase">Toplam Kayıt</div>
            <div class="text-2xl font-bold text-slate-900">@Model.TotalCount</div>
        </div>
    </div>

    <!-- Özet Kartlar -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 px-6 py-4">
            <div class="text-xs font-semibold tracking-[0.15em] text-slate-500 uppercase">Toplam Gider (Net)</div>
            <div class="mt-2 text-2xl font-bold text-slate-900">@Model.TotalAmountNet.ToString("N2") TL</div>
            <div class="mt-1 text-xs text-slate-400">Aralık: @RangeText()</div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 px-6 py-4">
            <div class="text-xs font-semibold tracking-[0.15em] text-slate-500 uppercase">Toplam Gider (Mutlak)</div>
            <div class="mt-2 text-2xl font-bold text-slate-900">@Model.TotalAmountAbs.ToString("N2") TL</div>
            <div class="mt-1 text-xs text-slate-400">Grafik/pasta için kullanılır.</div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 px-6 py-4">
            <div class="text-xs font-semibold tracking-[0.15em] text-slate-500 uppercase">Negatif Kayıt</div>
            <div class="mt-2 text-2xl font-bold text-rose-600">@Model.NegativeCount</div>
            <div class="mt-1 text-xs text-slate-400">Düzeltme/iptal/iade olabilir.</div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 px-6 py-4">
            <div class="text-xs font-semibold tracking-[0.15em] text-slate-500 uppercase">Pozitif Kayıt</div>
            <div class="mt-2 text-2xl font-bold text-emerald-600">@Model.PositiveCount</div>
            <div class="mt-1 text-xs text-slate-400">Normal gider kayıtları.</div>
        </div>
    </div>

    <!-- Filtre -->
    <form method="get" class="bg-white rounded-2xl shadow-sm border border-slate-100 p-5 mb-6">
        <div class="grid grid-cols-1 md:grid-cols-12 gap-4">

            <div class="md:col-span-3">
                <label class="text-[11px] font-semibold tracking-[0.15em] text-slate-500 uppercase">Dönem</label>
                <select name="period" id="periodSelect"
                        class="mt-2 w-full rounded-xl border border-slate-200 px-3 py-2 text-sm bg-white">
                    <option value="month" selected="@(Model.Period=="month")">Ay</option>
                    <option value="all" selected="@(Model.Period=="all")">Tüm Zamanlar</option>
                </select>
            </div>

            <div class="md:col-span-3" id="monthWrap">
                <label class="text-[11px] font-semibold tracking-[0.15em] text-slate-500 uppercase">Ay Seç</label>
                <input type="month" name="month" value="@Model.Month"
                       class="mt-2 w-full rounded-xl border border-slate-200 px-3 py-2 text-sm bg-white" />
            </div>

            <div class="md:col-span-4">
                <label class="text-[11px] font-semibold tracking-[0.15em] text-slate-500 uppercase">Arama</label>
                <input name="search" value="@Model.Search"
                       placeholder="Gider adı / kod / döviz / guid / tarih..."
                       class="mt-2 w-full rounded-xl border border-slate-200 px-4 py-2 text-sm bg-white focus:outline-none focus:ring-2 focus:ring-indigo-200" />
            </div>

            <div class="md:col-span-2">
                <label class="text-[11px] font-semibold tracking-[0.15em] text-slate-500 uppercase">Gösterim</label>
                <select name="pageSize" class="mt-2 w-full rounded-xl border border-slate-200 px-3 py-2 text-sm bg-white">
                    @{
                        var sizes = new[] { 10, 25, 50, 100 };
                        foreach (var s in sizes)
                        {
                            <option value="@s" selected="@(Model.PageSize == s)">@s</option>
                        }
                    }
                </select>
            </div>

            <div class="md:col-span-12 flex gap-2">
                <input type="hidden" name="sort" value="@Model.Sort" />

                <button class="flex-1 rounded-xl bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 text-sm font-semibold">
                    Uygula
                </button>

                <a asp-action="Index"
                   class="flex-1 text-center rounded-xl border border-slate-200 hover:bg-slate-50 px-4 py-2 text-sm font-semibold text-slate-700">
                    Temizle
                </a>
            </div>

            <div class="md:col-span-12 text-xs text-slate-500">
                Gösterilen aralık: <b>@RangeText()</b>
            </div>
        </div>
    </form>

    <!-- Grafik -->
    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-6 mb-6">
        <div class="flex items-start justify-between gap-4 mb-4">
            <div>
                <h2 class="text-lg font-semibold text-slate-900">Günlük Gider Grafiği</h2>
                <p class="text-xs text-slate-400 mt-1">Seçilen aralık için günlük toplam (mutlak tutar).</p>
            </div>
        </div>

        <div class="h-72">
            <canvas id="dailyChart"></canvas>
        </div>
    </div>

    <!-- Pasta -->
    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-6 mb-6">
        <div class="flex items-start justify-between gap-4 mb-4">
            <div>
                <h2 class="text-lg font-semibold text-slate-900">Gider Dağılımı</h2>
                <p class="text-xs text-slate-400 mt-1">Gider adı bazında (mutlak tutar ile) dilimlenmiş dağılım.</p>
            </div>
        </div>

        <div class="h-80">
            <canvas id="pieChart"></canvas>
        </div>
    </div>

    <!-- Liste Alanı -->
    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">

        <!-- ✅ MOBİL: Kart Liste -->
        <div class="gdr-cards p-3">
            @if (Model.Items != null && Model.Items.Any())
            {
                <div class="flex flex-col gap-3">
                    @foreach (var r in Model.Items)
                    {
                        var amt = r.MsgS1164 ?? 0;
                        var isNeg = amt < 0;

                        <div class="rounded-2xl border border-slate-100 bg-white shadow-sm p-3">
                            <div class="flex items-start justify-between gap-3">
                                <div class="min-w-0">
                                    <div class="text-[11px] text-slate-500">Tarih</div>
                                    <div class="text-sm font-semibold text-slate-900">
                                        @D(r.MsgS0089)
                                    </div>

                                    <div class="mt-2 text-[11px] text-slate-500">Gider</div>
                                    <div class="text-sm font-semibold text-slate-900 break-words">
                                        @S(r.MsgS1168)
                                    </div>
                                    <div class="text-[11px] text-slate-400 mt-1">
                                        Kod: <span class="font-mono">@S(r.MsgS1167)</span>
                                    </div>
                                </div>

                                <div class="shrink-0 text-right">
                                    <div class="text-[11px] text-slate-500">Tutar (TL)</div>
                                    <div class="text-sm font-bold @(isNeg ? "text-rose-600" : "text-slate-900")">
                                        @N2(r.MsgS1164)
                                    </div>

                                    <div class="mt-2 text-[11px] text-slate-500">Döviz</div>
                                    <div class="text-sm font-semibold text-slate-900">
                                        @S(r.MsgS1160)
                                    </div>
                                </div>
                            </div>

                            <div class="mt-3 grid grid-cols-2 gap-2">
                                <div class="rounded-xl bg-slate-50 border border-slate-100 p-2">
                                    <div class="text-[11px] text-slate-500">Döviz Tutarı</div>
                                    <div class="text-xs font-semibold text-slate-900">
                                        @N2(r.MsgS1165)
                                    </div>
                                </div>

                                <div class="rounded-xl bg-slate-50 border border-slate-100 p-2">
                                    <div class="text-[11px] text-slate-500">Kur (TL / Döviz)</div>
                                    <div class="text-xs font-semibold text-slate-900">
                                        @Kur(r.MsgS1164, r.MsgS1165)
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="px-4 py-10 text-center text-slate-400 text-xs">
                    Kayıt bulunamadı.
                </div>
            }

            <!-- Mobil Sayfalama -->
            <div class="flex items-center justify-between px-1 py-2 text-xs">
                <div class="text-slate-500">Sayfa <b>@Model.Page</b> / <b>@Model.TotalPages</b></div>
                <div class="flex items-center gap-2">
                    @{
                        var prevMobile = Model.Page - 1;
                        var nextMobile = Model.Page + 1;
                    }

                    <a class="px-3 py-2 rounded-xl border border-slate-200 hover:bg-slate-50 @(Model.Page <= 1 ? "pointer-events-none opacity-50" : "")"
                       asp-action="Index"
                       asp-route-period="@Model.Period"
                       asp-route-month="@Model.Month"
                       asp-route-search="@Model.Search"
                       asp-route-sort="@Model.Sort"
                       asp-route-pageSize="@Model.PageSize"
                       asp-route-page="@prevMobile">Önceki</a>

                    <a class="px-3 py-2 rounded-xl border border-slate-200 hover:bg-slate-50 @(Model.Page >= Model.TotalPages ? "pointer-events-none opacity-50" : "")"
                       asp-action="Index"
                       asp-route-period="@Model.Period"
                       asp-route-month="@Model.Month"
                       asp-route-search="@Model.Search"
                       asp-route-sort="@Model.Sort"
                       asp-route-pageSize="@Model.PageSize"
                       asp-route-page="@nextMobile">Sonraki</a>
                </div>
            </div>
        </div>

        <!-- ✅ WEB: Tablo (webde aynı kalsın) -->
        <div class="gdr-table">
            <div class="overflow-x-auto">
                <table class="min-w-[1100px] w-full text-left text-xs">
                    <thead class="bg-slate-50 border-b border-slate-100">
                        <tr class="text-slate-700">
                            <th class="px-4 py-3 font-semibold">
                                <a class="inline-flex items-center gap-2 hover:text-slate-900"
                                   asp-action="Index"
                                   asp-route-period="@Model.Period"
                                   asp-route-month="@Model.Month"
                                   asp-route-search="@Model.Search"
                                   asp-route-page="1"
                                   asp-route-pageSize="@Model.PageSize"
                                   asp-route-sort="@nextSort">
                                    Tarih <span class="text-[10px]">@(isAsc ? "↑" : "↓")</span>
                                </a>
                            </th>
                            <th class="px-4 py-3 font-semibold">Gider Kodu</th>
                            <th class="px-4 py-3 font-semibold">Gider Adı</th>
                            <th class="px-4 py-3 font-semibold text-right">Tutar (TL)</th>
                            <th class="px-4 py-3 font-semibold">Döviz</th>
                            <th class="px-4 py-3 font-semibold text-right">Döviz Tutarı</th>
                            <th class="px-4 py-3 font-semibold text-right">Kur (TL / Döviz)</th>
                        </tr>
                    </thead>

                    <tbody>
                        @if (Model.Items != null && Model.Items.Any())
                        {
                            foreach (var r in Model.Items)
                            {
                                var amt = r.MsgS1164 ?? 0;
                                var amtCls = amt < 0 ? "text-rose-600 font-semibold" : "text-slate-900";

                                <tr class="border-b border-slate-50 hover:bg-slate-50/60 text-[11px]">
                                    <td class="px-4 py-2 whitespace-nowrap">@D(r.MsgS0089)</td>
                                    <td class="px-4 py-2 whitespace-nowrap">@S(r.MsgS1167)</td>
                                    <td class="px-4 py-2 whitespace-nowrap">@S(r.MsgS1168)</td>
                                    <td class="px-4 py-2 whitespace-nowrap text-right @amtCls">@N2(r.MsgS1164)</td>
                                    <td class="px-4 py-2 whitespace-nowrap">@S(r.MsgS1160)</td>
                                    <td class="px-4 py-2 whitespace-nowrap text-right">@N2(r.MsgS1165)</td>
                                    <td class="px-4 py-2 whitespace-nowrap text-right">@Kur(r.MsgS1164, r.MsgS1165)</td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="7" class="px-4 py-8 text-center text-slate-400 text-sm">Kayıt bulunamadı.</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <!-- Web Sayfalama -->
            <div class="flex items-center justify-between px-5 py-4 border-t border-slate-100 text-xs">
                <div class="text-slate-500">Sayfa <b>@Model.Page</b> / <b>@Model.TotalPages</b></div>
                <div class="flex items-center gap-2">
                    @{
                        var prevWeb = Model.Page - 1;
                        var nextWeb = Model.Page + 1;
                    }

                    <a class="px-3 py-2 rounded-xl border border-slate-200 hover:bg-slate-50 @(Model.Page <= 1 ? "pointer-events-none opacity-50" : "")"
                       asp-action="Index"
                       asp-route-period="@Model.Period"
                       asp-route-month="@Model.Month"
                       asp-route-search="@Model.Search"
                       asp-route-sort="@Model.Sort"
                       asp-route-pageSize="@Model.PageSize"
                       asp-route-page="@prevWeb">Önceki</a>

                    <a class="px-3 py-2 rounded-xl border border-slate-200 hover:bg-slate-50 @(Model.Page >= Model.TotalPages ? "pointer-events-none opacity-50" : "")"
                       asp-action="Index"
                       asp-route-period="@Model.Period"
                       asp-route-month="@Model.Month"
                       asp-route-search="@Model.Search"
                       asp-route-sort="@Model.Sort"
                       asp-route-pageSize="@Model.PageSize"
                       asp-route-page="@nextWeb">Sonraki</a>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts{
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        // period=all ise month picker gizle
        const periodSelect = document.getElementById('periodSelect');
        const monthWrap = document.getElementById('monthWrap');

        function syncMonthVisibility(){
            const p = (periodSelect.value || 'month');
            monthWrap.style.display = (p === 'month') ? 'block' : 'none';
        }
        periodSelect.addEventListener('change', syncMonthVisibility);
        syncMonthVisibility();

        // Günlük grafik
        const dayLabels = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.DailyTotalsAbs.Select(x => x.Label)));
        const dayData   = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.DailyTotalsAbs.Select(x => x.Value)));

        const dailyCtx = document.getElementById('dailyChart').getContext('2d');
        new Chart(dailyCtx, {
            type: 'bar',
            data: {
                labels: dayLabels,
                datasets: [{
                    label: 'Günlük Gider (Mutlak)',
                    data: dayData,
                    borderRadius: 8,
                    maxBarThickness: 40
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { grid: { display: false } },
                    y: { beginAtZero: true }
                }
            }
        });

        // Pasta
        const pieLabels = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.PieByExpenseName.Select(x => x.Label)));
        const pieData   = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.PieByExpenseName.Select(x => x.Value)));

        const pieCtx = document.getElementById('pieChart').getContext('2d');
        new Chart(pieCtx, {
            type: 'doughnut',
            data: { labels: pieLabels, datasets: [{ data: pieData }] },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'right' },
                    tooltip: {
                        callbacks: {
                            label: function(ctx){
                                const v = ctx.raw || 0;
                                return `${ctx.label}: ${v.toLocaleString('tr-TR')} TL`;
                            }
                        }
                    }
                },
                cutout: '65%'
            }
        });
    </script>
}