@model ViotekErp.Models.ServisListVm
@using System.Globalization

@{
    string CariText(string? cariKod)
    {
        if (string.IsNullOrWhiteSpace(cariKod)) return "-";
        if (Model.CariAdlari != null && Model.CariAdlari.TryGetValue(cariKod, out var ad) && !string.IsNullOrWhiteSpace(ad))
            return ad;
        return cariKod;
    }

    string StokText(string? stokKod)
    {
        if (string.IsNullOrWhiteSpace(stokKod)) return "-";
        if (Model.StokAdlari != null && Model.StokAdlari.TryGetValue(stokKod, out var ad) && !string.IsNullOrWhiteSpace(ad))
            return ad;
        return stokKod;
    }

    string DurumText(byte? d) => d switch
    {
        1 => "Servis Kaydı Yapıldı",
        2 => "Tedarikçiye Gönderildi",
        3 => "Tedarikçiden Geldi",
        4 => "Müşteriye Teslim Edildi",
        _ => "Bilinmiyor"
    };

    string DateStr(DateTime? dt) => dt.HasValue
        ? dt.Value.ToString("dd.MM.yyyy", CultureInfo.GetCultureInfo("tr-TR"))
        : "-";

    // ✅ Kaç gündür açık (ServisTarih’e göre)
    int AcikGun(DateTime? servisTarih)
    {
        if (!servisTarih.HasValue) return 0;
        var days = (DateTime.Today - servisTarih.Value.Date).Days;
        return days < 0 ? 0 : days;
    }

    string PageUrl(int newPage)
    {
        var tab = Model.ActiveTab ?? "acilan";
        var search = Model.Search ?? "";
        var df = Model.DateFrom?.ToString("yyyy-MM-dd") ?? "";
        var dt = Model.DateTo?.ToString("yyyy-MM-dd") ?? "";

        return Url.Action("ListPartial", "Servis", new
        {
            tab,
            search,
            dateFrom = string.IsNullOrWhiteSpace(df) ? null : df,
            dateTo = string.IsNullOrWhiteSpace(dt) ? null : dt,
            page = newPage,
            pageSize = Model.PageSize
        }) ?? "#";
    }
}

<div class="bg-white rounded-2xl shadow-sm border border-slate-100 w-full max-w-full min-w-0 overflow-hidden">

    <div class="px-4 py-3 border-b border-slate-100 flex items-center justify-between gap-2 min-w-0">
        <div class="text-xs text-slate-500 truncate">
            Toplam: <span class="font-semibold text-slate-800">@Model.TotalCount</span>
        </div>

        <div class="text-xs text-slate-400 truncate">
            Sayfa: <span class="font-semibold text-slate-700">@Model.Page</span> / <span class="font-semibold text-slate-700">@Model.TotalPages</span>
        </div>
    </div>

    <!-- TABLO -->
    <div class="w-full max-w-full overflow-x-auto">
        <table class="w-full table-fixed text-xs">
            <thead class="bg-slate-50 border-b border-slate-100">
                <tr>
                    <th class="px-3 sm:px-4 py-3 font-semibold text-slate-500 w-28">Tarih</th>
                    <th class="px-3 sm:px-4 py-3 font-semibold text-slate-500">Müşteri</th>

                    <!-- md ve üstünde göster -->
                    <th class="hidden md:table-cell px-3 sm:px-4 py-3 font-semibold text-slate-500">Ürün</th>
                    <th class="hidden lg:table-cell px-3 sm:px-4 py-3 font-semibold text-slate-500 w-28">Seri</th>

                    <th class="px-3 sm:px-4 py-3 font-semibold text-slate-500 w-44">Durum</th>

                    <!-- md ve üstünde göster -->
                    <th class="hidden md:table-cell px-3 sm:px-4 py-3 font-semibold text-slate-500 w-40">Teslim Alan</th>

                    <th class="px-3 sm:px-4 py-3 font-semibold text-slate-500 text-right w-24">İşlem</th>
                </tr>
            </thead>

            <tbody>
            @if (Model.Items != null && Model.Items.Any())
            {
                foreach (var s in Model.Items)
                {
                    string teslimAlan = s.ServisTeslimAlan ?? "";
                    if ((s.ServisDurum ?? 1) == 3 && !string.IsNullOrWhiteSpace(s.TedAlimTeslimAlan))
                        teslimAlan = s.TedAlimTeslimAlan!;
                    if ((s.ServisDurum ?? 1) == 4 && !string.IsNullOrWhiteSpace(s.MusTeslimAlan))
                        teslimAlan = s.MusTeslimAlan!;

                    var acikGun = AcikGun(s.ServisTarih);

                    <tr class="border-b border-slate-50 hover:bg-slate-50/60 text-[11px] align-top">
                        <td class="px-3 sm:px-4 py-2 whitespace-nowrap">@DateStr(s.ServisTarih)</td>

                        <td class="px-3 sm:px-4 py-2 min-w-0">
                            <!-- ✅ Müşteri adı + Kaç gündür açık (YAN YANA) -->
                            <div class="flex items-start justify-between gap-2 min-w-0">
                                <div class="min-w-0">
                                    <div class="font-semibold text-slate-800 truncate">
                                        @CariText(s.ServisCariKod)
                                    </div>
                                    <div class="text-[10px] text-slate-400 truncate">
                                        Kod: @(s.ServisCariKod ?? "-")
                                    </div>
                                </div>

                                <div class="shrink-0 text-right">
                                    <div class="text-[10px] text-slate-400">Açık</div>
                                    <div class="text-[11px] font-semibold text-slate-700">
                                        @acikGun gün
                                    </div>
                                </div>
                            </div>

                            <!-- mobilde ürün bilgisini burada alt satır olarak göster -->
                            <div class="md:hidden mt-1 text-[10px] text-slate-500 truncate">
                                Ürün: @StokText(s.ServisStokKod)
                            </div>
                            <div class="lg:hidden md:hidden text-[10px] text-slate-400 truncate">
                                Seri: @(string.IsNullOrWhiteSpace(s.ServisSeriNumara) ? "-" : s.ServisSeriNumara)
                            </div>
                        </td>

                        <td class="hidden md:table-cell px-3 sm:px-4 py-2 min-w-0">
                            <div class="font-semibold text-slate-800 truncate">
                                @StokText(s.ServisStokKod)
                            </div>
                            <div class="text-[10px] text-slate-400 truncate">
                                Kod: @(s.ServisStokKod ?? "-")
                            </div>
                        </td>

                        <td class="hidden lg:table-cell px-3 sm:px-4 py-2 whitespace-nowrap">
                            @(string.IsNullOrWhiteSpace(s.ServisSeriNumara) ? "-" : s.ServisSeriNumara)
                        </td>

                        <td class="px-3 sm:px-4 py-2 whitespace-nowrap">
                            <span class="inline-flex items-center px-2 py-1 rounded-full border border-slate-200 bg-white text-slate-700 max-w-[170px] truncate">
                                @DurumText(s.ServisDurum)
                            </span>
                        </td>

                        <td class="hidden md:table-cell px-3 sm:px-4 py-2 whitespace-nowrap">
                            @(string.IsNullOrWhiteSpace(teslimAlan) ? "-" : teslimAlan)
                        </td>

                        <td class="px-3 sm:px-4 py-2 whitespace-nowrap text-right">
                            <button type="button"
                                    class="svc-detail-btn inline-flex items-center justify-center px-3 py-1.5 rounded-lg bg-indigo-600 text-white text-[11px] font-semibold hover:bg-indigo-700 transition"
                                    data-id="@s.ServisId">
                                Detay
                            </button>
                        </td>
                    </tr>
                }
            }
            else
            {
                <tr>
                    <td colspan="7" class="px-4 py-10 text-center text-slate-400 text-xs">
                        Kayıt bulunamadı.
                    </td>
                </tr>
            }
            </tbody>
        </table>
    </div>

    @if (Model.TotalPages > 1)
    {
        <div class="px-4 py-3 border-t border-slate-100 flex items-center justify-between gap-2">
            <div class="text-[11px] text-slate-500">@Model.TotalCount kayıt</div>

            <div class="flex items-center gap-2">
                @{
                    var prev = Model.Page - 1;
                    var next = Model.Page + 1;
                    var canPrev = Model.Page > 1;
                    var canNext = Model.Page < Model.TotalPages;
                }

                <a href="@(canPrev ? PageUrl(prev) : "#")"
                   class="px-3 py-1.5 rounded-lg border text-[11px] font-semibold
                          @(canPrev ? "border-slate-200 text-slate-700 hover:bg-slate-50" : "border-slate-100 text-slate-300 pointer-events-none")">
                    Önceki
                </a>

                <div class="text-[11px] text-slate-500 px-2 whitespace-nowrap">
                    @Model.Page / @Model.TotalPages
                </div>

                <a href="@(canNext ? PageUrl(next) : "#")"
                   class="px-3 py-1.5 rounded-lg border text-[11px] font-semibold
                          @(canNext ? "border-slate-200 text-slate-700 hover:bg-slate-50" : "border-slate-100 text-slate-300 pointer-events-none")">
                    Sonraki
                </a>
            </div>
        </div>
    }
</div>