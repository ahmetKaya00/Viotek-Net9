@model ViotekErp.Models.DashboardViewModel
@using System.Linq
@using System.Security.Claims

@{
    Layout = "_ErpLayout";
    ViewData["Title"] = "YÃ¶netim Paneli";

    // âœ… Grafik datasÄ± artÄ±k ChartPoints
    var chartTotal = Model.ChartPoints?.Sum(x => x.Amount) ?? 0;
    var chartTotalKdvli = chartTotal * 1.20;

    var bestDay = Model.ChartPoints?
        .OrderByDescending(x => x.Amount)
        .FirstOrDefault();
}

@{
    var role = User?.FindFirst(ClaimTypes.Role)?.Value ?? "";
    var isAdmin = string.Equals(role, "Admin", StringComparison.OrdinalIgnoreCase);

    var displayName =
        User?.FindFirst("AdSoyad")?.Value ??
        User?.FindFirst(ClaimTypes.Name)?.Value ??
        "KullanÄ±cÄ±";
}

@if (!isAdmin)
{
    <div class="min-h-[calc(100vh-64px)] bg-slate-50 px-6 py-6">
        <div class="max-w-4xl mx-auto">

            <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-6">
                <h1 class="text-2xl font-bold text-slate-900">
                    Selam @displayName ðŸ‘‹
                </h1>
                <p class="text-sm text-slate-500 mt-2">
                    HoÅŸ geldin. Bu panelde sadece yetkili olduÄŸun alanlarÄ± gÃ¶rebilirsin.
                </p>

                <div class="mt-6 grid grid-cols-1 sm:grid-cols-2 gap-3">
                    <a asp-controller="Siparisler" asp-action="Index"
                       class="rounded-2xl border border-slate-100 bg-white p-5 shadow-sm hover:shadow-md transition">
                        <div class="text-xs font-semibold tracking-[0.15em] text-slate-500 uppercase">
                            SipariÅŸler
                        </div>
                        <div class="mt-2 text-base font-semibold text-slate-900">
                            SipariÅŸ ekranÄ±na git
                        </div>
                        <div class="mt-1 text-xs text-slate-400">
                            SipariÅŸleri gÃ¶rÃ¼ntÃ¼le / filtrele
                        </div>
                    </a>

                    <a asp-controller="Stoklar" asp-action="Index"
                       class="rounded-2xl border border-slate-100 bg-white p-5 shadow-sm hover:shadow-md transition">
                        <div class="text-xs font-semibold tracking-[0.15em] text-slate-500 uppercase">
                            Stok YÃ¶netimi
                        </div>
                        <div class="mt-2 text-base font-semibold text-slate-900">
                            Stok ekranÄ±na git
                        </div>
                        <div class="mt-1 text-xs text-slate-400">
                            StoklarÄ± gÃ¶rÃ¼ntÃ¼le / kontrol et
                        </div>
                    </a>
                </div>

                <div class="mt-6 text-xs text-slate-400">
                    Not: Daha fazla yetki gerekiyorsa admin kullanÄ±cÄ±dan talep edebilirsin.
                </div>
            </div>

        </div>
    </div>

    @* User ise dashboardâ€™un geri kalanÄ±nÄ± hiÃ§ Ã§izme *@
    return;
}

<style>
    /* Tailwind breakpointlerinden baÄŸÄ±msÄ±z kesin Ã§Ã¶zÃ¼m */
    .dash-cards { display: none; }   /* default: web */
    .dash-table { display: block; }  /* default: web */

    @@media (max-width: 640px) {
        .dash-cards { display: block; }
        .dash-table { display: none; }
    }
  .svc-kpi-grid{
    display: grid !important;
    grid-template-columns: repeat(5, minmax(0, 1fr)) !important;
    gap: 1rem;
  }

  /* Ä°stersen mobilde alt alta kalsÄ±n */
  @@media (max-width: 640px){
    .svc-kpi-grid{
      grid-template-columns: 1fr !important;
    }
  }

</style>

<div class="min-h-[calc(100vh-64px)] bg-slate-50 px-6 py-6">

    <!-- BaÅŸlÄ±k -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4">
        <div>
            <h1 class="text-3xl font-bold text-slate-900">YÃ¶netim Paneli</h1>
            <p class="text-sm text-slate-500 mt-1">
                MikroDB_V16_VIOTEK sipariÅŸ verilerine gÃ¶re Ã¶zet gÃ¶rÃ¼nÃ¼m.
            </p>
        </div>
    </div>

    <!-- âœ… Filtre BarÄ± -->
    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-4 mb-6">
        <form method="get" class="grid grid-cols-1 md:grid-cols-6 gap-3 items-end">

            <div class="md:col-span-2">
                <label class="block text-xs font-semibold text-slate-600 mb-1">DÃ¶nem</label>
                <select name="period" id="periodSelect"
                        class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm bg-white
                               focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="day" selected="@(Model.Period == "day" ? "selected" : null)">GÃ¼nlÃ¼k (BugÃ¼n)</option>
                    <option value="week" selected="@(Model.Period == "week" ? "selected" : null)">HaftalÄ±k (Son 7 GÃ¼n)</option>
                    <option value="month" selected="@(Model.Period == "month" ? "selected" : null)">AylÄ±k (Bu Ay)</option>
                    <option value="year" selected="@(Model.Period == "year" ? "selected" : null)">YÄ±llÄ±k (Bu YÄ±l)</option>
                    <option value="custom" selected="@(Model.Period == "custom" ? "selected" : null)">Tarih SeÃ§ (Ã–zel)</option>
                </select>
            </div>

            <div class="md:col-span-2" id="customStartWrap">
                <label class="block text-xs font-semibold text-slate-600 mb-1">BaÅŸlangÄ±Ã§</label>
                <input type="date"
                       name="startDate"
                       value="@(Model.FilterStartDate?.ToString("yyyy-MM-dd") ?? "")"
                       class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm
                              focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" />
            </div>

            <div class="md:col-span-2" id="customEndWrap">
                <label class="block text-xs font-semibold text-slate-600 mb-1">BitiÅŸ</label>
                <input type="date"
                       name="endDate"
                       value="@(Model.FilterEndDate?.ToString("yyyy-MM-dd") ?? "")"
                       class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm
                              focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" />
            </div>

            <div class="md:col-span-6 flex gap-2">
                <button type="submit"
                        class="inline-flex items-center justify-center px-4 py-2 rounded-lg
                               bg-indigo-600 text-white text-sm font-medium shadow-sm
                               hover:bg-indigo-700 transition">
                    Uygula
                </button>
                <a asp-controller="Dashboard" asp-action="Index"
                   class="inline-flex items-center justify-center px-3 py-2 rounded-lg
                          border border-slate-200 text-xs text-slate-600 hover:bg-slate-50">
                    SÄ±fÄ±rla
                </a>

                <div class="ml-auto text-[11px] text-slate-500 flex items-center">
                    GÃ¶sterilen aralÄ±k:
                    <span class="font-semibold text-slate-700 ml-1">
                        @(Model.FilterStartDate?.ToString("dd.MM.yyyy")) â€” @(Model.FilterEndDate?.ToString("dd.MM.yyyy"))
                    </span>
                </div>
            </div>
        </form>
    </div>

    <!-- Ãœst Kartlar -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">

        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 px-6 py-4 flex items-center justify-between">
            <div>
                <p class="text-xs font-semibold tracking-[0.15em] text-slate-500 uppercase">
                    TOPLAM SATIÅž (SEÃ‡Ä°LEN DÃ–NEM) - KDV HARÄ°Ã‡
                </p>

                <div class="mt-3 space-y-2">
                    <div>
                        <div class="text-[11px] text-slate-500">TL (KDV HariÃ§)</div>
                        <div class="text-2xl font-bold text-emerald-600">
                            @Model.MonthlySalesTotal.ToString("N2") TL
                        </div>
                        <div class="text-xs text-slate-400">
                            KDV %20 Dahil: @((Model.MonthlySalesTotal * 1.20).ToString("N2")) TL
                        </div>
                    </div>

                    <div class="pt-2 border-t border-slate-100">
                        <div class="text-[11px] text-slate-500">USD (KDV HariÃ§)</div>
                        <div class="text-xl font-bold text-slate-900">
                            @Model.MonthlySalesTotalUsd.ToString("N2") USD
                        </div>
                        <div class="text-xs text-slate-400">
                            KDV %20 Dahil: @((Model.MonthlySalesTotalUsd * 1.20).ToString("N2")) USD
                        </div>
                    </div>
                </div>

            </div>
            <div class="w-10 h-10 rounded-full bg-emerald-100 flex items-center justify-center">
                <span class="text-emerald-500 text-xl">ðŸ’µ</span>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 px-6 py-4 flex items-center justify-between">
            <div>
                <p class="text-xs font-semibold tracking-[0.15em] text-slate-500 uppercase">
                    BUGÃœNKÃœ SÄ°PARÄ°ÅžLER
                </p>
                <p class="mt-3 text-2xl font-bold text-indigo-600">
                    @Model.TodayOrderCount
                </p>
                <p class="mt-1 text-xs text-slate-400">
                    BugÃ¼nÃ¼n sipariÅŸ satÄ±rÄ± sayÄ±sÄ±.
                </p>
            </div>
            <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center">
                <span class="text-indigo-500 text-xl">ðŸ“¦</span>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 px-6 py-4 flex items-center justify-between">
            <div>
                <p class="text-xs font-semibold tracking-[0.15em] text-slate-500 uppercase">
                    DÃ–NEMÄ°N PERSONELÄ°
                </p>

                @if (!string.IsNullOrWhiteSpace(Model.EmployeeOfMonthName))
                {
                    <p class="mt-2 text-base font-semibold text-slate-900">
                        @Model.EmployeeOfMonthName
                    </p>
                    <p class="text-sm font-bold text-emerald-600">
                        +@Model.EmployeeOfMonthSales.ToString("N2") TL satÄ±ÅŸ
                    </p>
                    <p class="text-xs text-slate-400">
                        (KDV %20 Dahil: @((Model.EmployeeOfMonthSales * 1.20).ToString("N2")) TL)
                    </p>
                }
                else
                {
                    <p class="mt-2 text-sm text-slate-400">
                        Veri bulunamadÄ±.
                    </p>
                }
            </div>
            <div class="w-10 h-10 rounded-full bg-amber-100 flex items-center justify-center">
                <span class="text-amber-500 text-xl">ðŸ‘¤</span>
            </div>
        </div>
    </div>

    <!-- Grafik -->
    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-6 mb-4">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4">
            <div>
                <h2 class="text-lg font-semibold text-slate-900">SatÄ±ÅŸ GrafiÄŸi</h2>
                <p class="text-xs text-slate-400 mt-1">
                    SeÃ§ilen dÃ¶neme gÃ¶re satÄ±ÅŸ (TL net, KDV hariÃ§).
                </p>
            </div>

            <div class="flex flex-wrap gap-4 text-xs">
                <div class="px-3 py-2 rounded-xl bg-slate-50 border border-slate-100">
                    <p class="text-slate-500">Grafik Toplam (KDV HariÃ§)</p>
                    <p class="font-semibold text-slate-800">@chartTotal.ToString("N2") TL</p>
                    <p class="text-slate-400">KDV %20 Dahil: @chartTotalKdvli.ToString("N2") TL</p>
                </div>

                @if (bestDay != null)
                {
                    <div class="px-3 py-2 rounded-xl bg-slate-50 border border-slate-100">
                        <p class="text-slate-500">En YoÄŸun</p>
                        <p class="font-semibold text-slate-800">
                            @bestDay.DayLabel â€” @bestDay.Amount.ToString("N2") TL
                        </p>
                    </div>
                }
            </div>
        </div>

        <div class="h-72">
            <canvas id="weeklyChart"></canvas>
        </div>
    </div>

    <!-- âœ… SERVÄ°S KARTLARI: GRAFÄ°ÄžÄ°N ALTINDA ve 5'LÄ° YAN YANA -->
<div class="svc-kpi-grid mb-6">
        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 px-4 py-4 flex items-center justify-between">
            <div>
                <p class="text-[10px] font-semibold tracking-[0.15em] text-slate-500 uppercase">AÃ‡ILAN</p>
                <p class="mt-2 text-2xl font-bold text-indigo-600">@((int)(ViewBag.ServisAcilanCount ?? 0))</p>
                <p class="mt-1 text-[10px] text-slate-400">ServisDurum: 1</p>
            </div>
            <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center">
                <span class="text-indigo-500 text-xl">ðŸ§¾</span>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 px-4 py-4 flex items-center justify-between">
            <div>
                <p class="text-[10px] font-semibold tracking-[0.15em] text-slate-500 uppercase">TEDARÄ°KÃ‡Ä°DE</p>
                <p class="mt-2 text-2xl font-bold text-amber-600">@((int)(ViewBag.ServisTedarikcideCount ?? 0))</p>
                <p class="mt-1 text-[10px] text-slate-400">ServisDurum: 2</p>
            </div>
            <div class="w-10 h-10 rounded-full bg-amber-100 flex items-center justify-center">
                <span class="text-amber-500 text-xl">ðŸšš</span>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 px-4 py-4 flex items-center justify-between">
            <div>
                <p class="text-[10px] font-semibold tracking-[0.15em] text-slate-500 uppercase">TEDARÄ°KÃ‡Ä°DEN GELEN</p>
                <p class="mt-2 text-2xl font-bold text-sky-600">@((int)(ViewBag.ServisTedarikcidenGelenCount ?? 0))</p>
                <p class="mt-1 text-[10px] text-slate-400">ServisDurum: 3</p>
            </div>
            <div class="w-10 h-10 rounded-full bg-sky-100 flex items-center justify-center">
                <span class="text-sky-500 text-xl">ðŸ“¥</span>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 px-4 py-4 flex items-center justify-between">
            <div>
                <p class="text-[10px] font-semibold tracking-[0.15em] text-slate-500 uppercase">TESLÄ°M EDÄ°LEN</p>
                <p class="mt-2 text-2xl font-bold text-emerald-600">@((int)(ViewBag.ServisTeslimEdilenCount ?? 0))</p>
                <p class="mt-1 text-[10px] text-slate-400">ServisDurum: 4</p>
            </div>
            <div class="w-10 h-10 rounded-full bg-emerald-100 flex items-center justify-center">
                <span class="text-emerald-500 text-xl">âœ…</span>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 px-4 py-4 flex items-center justify-between">
            <div>
                <p class="text-[10px] font-semibold tracking-[0.15em] text-slate-500 uppercase">TOPLAM</p>
                <p class="mt-2 text-2xl font-bold text-slate-900">@((int)(ViewBag.ServisTotalCount ?? 0))</p>
                <p class="mt-1 text-[10px] text-slate-400">Aktif servisler</p>
            </div>
            <div class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center">
                <span class="text-slate-500 text-xl">ðŸ“Š</span>
            </div>
        </div>

    </div>

    <!-- Son 10 SipariÅŸ -->
    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-6">
        <div class="flex items-center justify-between mb-4">
            <div>
                <h2 class="text-lg font-semibold text-slate-900">Son 10 SipariÅŸ</h2>
                <p class="text-xs text-slate-400 mt-1">
                    VeritabanÄ±ndaki en son 10 sipariÅŸ satÄ±rÄ±.
                </p>
            </div>

            <a asp-controller="Siparisler" asp-action="Index"
               class="inline-flex items-center px-3 py-1.5 rounded-full border border-slate-200 text-[11px] text-slate-600 hover:bg-slate-50">
                TÃ¼m SipariÅŸleri GÃ¶r
            </a>
        </div>

        <!-- âœ… MOBÄ°L: Kartlar -->
        <div class="dash-cards">
            @if (Model.LastOrders != null && Model.LastOrders.Any())
            {
                <div class="flex flex-col gap-3">
                    @foreach (var s in Model.LastOrders)
                    {
                        var musteriText = s.MusteriKod ?? "";
                        if (!string.IsNullOrEmpty(s.MusteriKod) &&
                            Model.LastOrdersMusteriAdlari != null &&
                            Model.LastOrdersMusteriAdlari.TryGetValue(s.MusteriKod, out var mAd))
                        {
                            musteriText = $"{s.MusteriKod} - {mAd}";
                        }

                        var saticiText = s.SaticiKod ?? "";
                        if (!string.IsNullOrEmpty(s.SaticiKod) &&
                            Model.LastOrdersSaticiAdlari != null &&
                            Model.LastOrdersSaticiAdlari.TryGetValue(s.SaticiKod, out var sAd))
                        {
                            saticiText = $"{s.SaticiKod} - {sAd}";
                        }

                        <div class="rounded-2xl border border-slate-100 bg-white shadow-sm p-3">
                            <div class="flex items-start justify-between gap-3">
                                <div class="min-w-0">
                                    <div class="text-[11px] text-slate-500">Tarih</div>
                                    <div class="text-sm font-semibold text-slate-900">
                                        @s.SipTarih?.ToString("dd.MM.yyyy")
                                    </div>

                                    <div class="mt-2 text-[11px] text-slate-500">MÃ¼ÅŸteri</div>
                                    <div class="text-sm font-semibold text-slate-900 break-words">
                                        @musteriText
                                    </div>

                                    <div class="mt-2 text-[11px] text-slate-500">SatÄ±cÄ±</div>
                                    <div class="text-sm font-semibold text-slate-900 break-words">
                                        @saticiText
                                    </div>
                                </div>

                                <div class="shrink-0 text-right">
                                    <div class="text-[11px] text-slate-500">Miktar</div>
                                    <div class="text-sm font-semibold text-slate-900">
                                        @(s.ToplamMiktar?.ToString("N2") ?? "-")
                                    </div>

                                    <div class="mt-2 text-[11px] text-slate-500">Tutar (TL)</div>
                                    <div class="text-sm font-bold text-emerald-700">
                                        @(s.TutarKdvliTL?.ToString("N2") ?? "-") TL
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="px-4 py-10 text-center text-slate-400 text-xs">
                    HenÃ¼z sipariÅŸ bulunamadÄ±.
                </div>
            }
        </div>

        <!-- âœ… WEB: Tablo -->
        <div class="dash-table">
            <div class="overflow-x-auto">
                <table class="min-w-full text-left text-xs">
                    <thead class="bg-slate-50 border-b border-slate-100">
                        <tr>
                            <th class="px-4 py-3 font-semibold text-slate-500">Tarih</th>
                            <th class="px-4 py-3 font-semibold text-slate-500">MÃ¼ÅŸteri</th>
                            <th class="px-4 py-3 font-semibold text-slate-500">SatÄ±cÄ±</th>
                            <th class="px-4 py-3 font-semibold text-slate-500 text-right">Miktar</th>
                            <th class="px-4 py-3 font-semibold text-slate-500 text-right">Tutar (TL)</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model.LastOrders != null && Model.LastOrders.Any())
                        {
                            foreach (var s in Model.LastOrders)
                            {
                                <tr class="border-b border-slate-50 hover:bg-slate-50/60 text-[11px]">
                                    <td class="px-4 py-2 whitespace-nowrap">@s.SipTarih?.ToString("dd.MM.yyyy")</td>
                                    <td class="px-4 py-2 whitespace-nowrap">
                                        @{
                                            var mk = s.MusteriKod ?? "";
                                            if (!string.IsNullOrEmpty(s.MusteriKod) &&
                                                Model.LastOrdersMusteriAdlari != null &&
                                                Model.LastOrdersMusteriAdlari.TryGetValue(s.MusteriKod, out var mAd))
                                            {
                                                mk = $"{s.MusteriKod} - {mAd}";
                                            }
                                            @mk
                                        }
                                    </td>
                                    <td class="px-4 py-2 whitespace-nowrap">
                                        @{
                                            var sk = s.SaticiKod ?? "";
                                            if (!string.IsNullOrEmpty(s.SaticiKod) &&
                                                Model.LastOrdersSaticiAdlari != null &&
                                                Model.LastOrdersSaticiAdlari.TryGetValue(s.SaticiKod, out var sAd))
                                            {
                                                sk = $"{s.SaticiKod} - {sAd}";
                                            }
                                            @sk
                                        }
                                    </td>
                                    <td class="px-4 py-2 text-right whitespace-nowrap">@(s.ToplamMiktar?.ToString("N2") ?? "")</td>
                                    <td class="px-4 py-2 text-right whitespace-nowrap">@(s.TutarKdvliTL?.ToString("N2") ?? "") TL</td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="6" class="px-4 py-6 text-center text-slate-400 text-xs">
                                    HenÃ¼z sipariÅŸ bulunamadÄ±.
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>

</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        // âœ… custom tarih alanlarÄ±nÄ± sadece "custom" seÃ§ince gÃ¶ster
        (function () {
            const sel = document.getElementById("periodSelect");
            const startWrap = document.getElementById("customStartWrap");
            const endWrap = document.getElementById("customEndWrap");

            function toggle() {
                const isCustom = (sel.value === "custom");
                startWrap.style.display = isCustom ? "block" : "none";
                endWrap.style.display = isCustom ? "block" : "none";
            }

            sel.addEventListener("change", toggle);
            toggle();
        })();

        // Chart
        const labels = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
            Model.ChartPoints.Select(x => x.DayLabel)));

        const data = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
            Model.ChartPoints.Select(x => x.Amount)));

        const ctx = document.getElementById('weeklyChart').getContext('2d');

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'SatÄ±ÅŸ TutarÄ± (TL)',
                    data: data,
                    borderRadius: 8,
                    maxBarThickness: 40
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { grid: { display: false } },
                    y: { beginAtZero: false }
                }
            }
        });
    </script>
}